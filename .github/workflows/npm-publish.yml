name: Clean install prod deps
  run:
    rm -rf node_modules
    npm ci --omit=dev

# If you bundle to dist/, do it here

- name: Stage files exactly as ZIP root
  run: |
    rm -rf bundle
    mkdir bundle
    # Copy ONLY what Lambda needs
    cp package.json bundle/ || true
    cp index.js bundle/ 2>/dev/null || true
    cp -R dist bundle/dist 2>/dev/null || true
    cp -R src bundle/src 2>/dev/null || true
    cp -R node_modules bundle/node_modules
    # Sanity check
    ls -la bundle
    test -f bundle/index.js -o -f bundle/dist/handler.js

- name: Create ZIP from inside the bundle (no parent folder)
  run: |
    cd bundle
    zip -r ../function.zip . -x "*.test.*" "node_modules/.bin/*"

- name: Upload artifact
  uses: actions/upload-artifact@v4
  with:
    name: lambda-zip
    path: function.zip
