name: Package AWS Lambda (Node ESM)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_DIR: .
  ZIP_NAME: lambda.zip
  NODE_VERSION: '20'   # Match your Lambda runtime (Node.js 20.x recommended)

jobs:
  build-and-zip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: Install deps and optional build
        working-directory: ${{ env.APP_DIR }}
        shell: bash
        env:
          CI: "true"
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

          # Run build only if it exists
          if npm run -s | grep -qE '^  build'; then
            npm run build
          else
            echo "::notice::No build script; skipping"
          fi

      - name: Stage runtime files (no nesting)
        working-directory: ${{ env.APP_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          rm -rf package
          mkdir -p package

          # Ship only what Lambda needs
          rsync -a \
            --include "index.mjs" \
            --include "src/***" \
            --include "package.json" \
            --include "package-lock.json" \
            --exclude ".git/***" \
            --exclude ".github/***" \
            --exclude "tests/***" \
            --exclude "test/***" \
            --exclude "coverage/***" \
            --exclude "node_modules/***" \
            --exclude "*.log" \
            --exclude "README.md" \
            --exclude ".gitignore" \
            ./ package/

          # Install production deps inside the staged folder
          if [ -f package/package.json ]; then
            ( cd package
              if [ -f package-lock.json ]; then
                npm ci --omit=dev --no-audit --no-fund
              else
                npm install --omit=dev --no-audit --no-fund
              fi
            )
          fi

          echo "Top-level staged files:"
          ls -la package | sed -n '1,200p'

      - name: Create Lambda zip (flat root)
        working-directory: ${{ env.APP_DIR }}/package
        shell: bash
        env:
          ZIP_NAME: ${{ env.ZIP_NAME }}
        run: |
          set -euo pipefail
          # Zip the CONTENTS so the root of the zip is files, not a folder
          zip -r "../${ZIP_NAME}" . -q
          echo "Created ../${ZIP_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.APP_DIR }}/${{ env.ZIP_NAME }}
          if-no-files-found: error
