name: Package AWS Lambda (Node)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # If your Lambda function lives in a subfolder, change this.
  APP_DIR: .
  # If your build emits compiled output (e.g. TypeScript -> dist), set this to that folder.
  BUILD_OUT: dist
  ZIP_NAME: lambda.zip
  NODE_VERSION: '20'   # or '20' if your Lambda runtime is Node.js 20.x

jobs:
  build-and-zip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: Install deps (for build) and build
        working-directory: ${{ env.APP_DIR }}
        run: |
          npm ci
          npm run build

      # Create a clean staging folder that will mirror the zip root
      - name: Stage runtime files
        shell: bash
        working-directory: ${{ env.APP_DIR }}
        run: |
          set -euo pipefail
          rm -rf package
          mkdir -p package

          # If a build output folder exists, we ship that; otherwise ship sources.
          if [ -d "${BUILD_OUT}" ] && [ "$(ls -A ${BUILD_OUT})" ]; then
            rsync -a --delete "${BUILD_OUT}/" "package/"
          else
            # Ship source files except obvious junk
            rsync -a --delete \
              --exclude ".git/" \
              --exclude ".github/" \
